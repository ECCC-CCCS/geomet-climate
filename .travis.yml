language: python

dist: bionic
sudo: false

python:
  - "3.6"

#virtualenv:
#  system_site_packages: true

env:
  global:
    - DEBIAN_FRONTEND=noninteractive
    - CPLUS_INCLUDE_PATH=/usr/include/gdal
    - C_INCLUDE_PATH=/usr/include/gdal
    - GEOMET_CLIMATE_BASEDIR=$TRAVIS_BUILD_DIR/_build
    - GEOMET_CLIMATE_DATADIR=$TRAVIS_BUILD_DIR/tests/data/climate
    - GEOMET_CLIMATE_CONFIG=$TRAVIS_BUILD_DIR/tests/geomet-climate-test.yml
    - GEOMET_CLIMATE_URL=http://localhost:8099/

addons:
  apt:
    sources:
      - sourceline: 'ppa:ubuntugis/ubuntugis-stable'
    packages:
      - gdal-bin
      - libgdal-dev
      - libsqlite3-mod-spatialite

before_install:
  - sudo apt-get -qq update
#  - sudo apt-get install -y python3-software-properties
#  - sudo add-apt-repository -y ppa:ubuntugis/ppa
#  - sudo apt-get update
  - sudo apt-get install -y python3-gdal devscripts fakeroot mapserver-bin python3-matplotlib python3-mapscript debhelper python3-setuptools

install:
  - pip3 install GDAL==`gdalinfo --version | cut -d' ' -f2 | cut -d',' -f1`
  - pip3 install click mappyfile pyyaml
  - pip3 install -r requirements-dev.txt
  - python3 setup.py install

script:
  - . tests/geomet-climate-test.env
  - python3 setup.py test
  - find . -type f -name "*.py" | xargs flake8
  - geomet-climate vrt generate
  - geomet-climate tileindex generate
  - geomet-climate legend generate
  - geomet-climate mapfile generate -s WMS
  - geomet-climate mapfile generate -s WCS
  - mapserv -nh QUERY_STRING="map=$GEOMET_CLIMATE_BASEDIR/mapfile/geomet-climate-WMS-en.map&service=WMS&version=1.3.0&request=GetCapabilities" > $GEOMET_CLIMATE_BASEDIR/geomet-climate-WMS-1.3.0-capabilities-en.xml
  - mapserv -nh QUERY_STRING="map=$GEOMET_CLIMATE_BASEDIR/mapfile/geomet-climate-WMS-fr.map&lang=fr&service=WMS&version=1.3.0&request=GetCapabilities" > $GEOMET_CLIMATE_BASEDIR/geomet-climate-WMS-1.3.0-capabilities-fr.xml
  - mapserv -nh QUERY_STRING="map=$GEOMET_CLIMATE_BASEDIR/mapfile/geomet-climate-WCS-en.map&service=WCS&version=2.1.0&request=GetCapabilities" > $GEOMET_CLIMATE_BASEDIR/geomet-climate-WCS-2.0.1-capabilities-en.xml
  - mapserv -nh QUERY_STRING="map=$GEOMET_CLIMATE_BASEDIR/mapfile/geomet-climate-WCS-fr.map&lang=fr&service=WCS&version=2.1.0&request=GetCapabilities" > $GEOMET_CLIMATE_BASEDIR/geomet-climate-WCS-2.0.1-capabilities-fr.xml

after_success:
  - echo $GEOMET_CLIMATE_BASEDIR
  - echo $GEOMET_CLIMATE_DATADIR
  - echo $GEOMET_CLIMATE_CONFIG
  - echo $GEOMET_CLIMATE_URL
  - python3 setup.py cleanbuild
  - python3 setup.py sdist bdist_wheel --universal
  - debuild -b -uc -us
